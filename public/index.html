<!doctype html>
<html lang="it">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
  <title>Manuel • AI Interview</title>
  <style>
    :root{
      --bg:#0d1220;
      --card:#131934;
      --muted:#9aa4bf;
      --text:#e6ebff;
      --accent:#6aa1ff;
      --pad:16px;
      --radius:18px;
      --kb:0px; /* set via JS (VisualViewport) */
    }
    *{box-sizing:border-box}
    html,body{height:100%;margin:0;background:var(--bg);color:var(--text);font:16px/1.4 system-ui,Segoe UI,Roboto,Helvetica,Arial,sans-serif}
    .wrap{
      height:100dvh;min-height:100svh;display:flex;flex-direction:column;
      padding:calc(env(safe-area-inset-top)) calc(env(safe-area-inset-left)) calc(env(safe-area-inset-bottom));
    }
    header{padding:12px var(--pad);font-weight:600;opacity:.9}
    .chat{
      flex:1;min-height:0;
      overflow:auto; -webkit-overflow-scrolling:touch;
      scrollbar-width:none; -ms-overflow-style:none;
      overscroll-behavior:contain; touch-action:pan-y;
      padding:8px var(--pad) 4px;
    }
    .chat::-webkit-scrollbar{width:0;height:0}
    .msg{max-width:760px;margin:8px 0;display:flex;gap:10px;align-items:flex-end}
    .msg .bubble{
      padding:12px 14px;border-radius:16px; background:var(--card);
      box-shadow:0 4px 12px rgba(0,0,0,.25);
      white-space:pre-wrap; word-wrap:break-word; overflow-wrap:anywhere;
    }
    .msg.me{justify-content:flex-end}
    .msg.me .bubble{background:#243159}
    .time{font-size:11px;color:var(--muted);margin:0 6px 2px}
    .composer{
      position:sticky;bottom:0;left:0;right:0;
      padding:12px var(--pad) calc(12px + env(safe-area-inset-bottom) + var(--kb));
      background:linear-gradient(180deg, rgba(13,18,32,0) 0%, rgba(13,18,32,.85) 30%, rgba(13,18,32,1) 60%);
      backdrop-filter:saturate(1.2) blur(6px);
    }
    .row{
      display:grid; grid-template-columns:1fr auto; gap:10px; align-items:end;
      max-width:960px; margin:0 auto;
    }
    textarea{
      resize:none; width:100%; min-height:56px; max-height:45dvh;
      background:var(--card); color:var(--text); border:none; outline:none;
      padding:12px 14px; border-radius:var(--radius);
      line-height:1.35; font-size:16px; /* evita zoom iOS */
      box-shadow:inset 0 0 0 1px rgba(255,255,255,.04);
    }
    button{
      height:56px; padding:0 18px; border-radius:var(--radius); border:none;
      background:var(--accent); color:white; font-weight:600; cursor:pointer;
      box-shadow:0 6px 18px rgba(106,161,255,.35);
    }
    button[disabled]{opacity:.6;cursor:not-allowed}
    @media (max-width:640px){
      header{padding:10px var(--pad) 4px}
      .msg .bubble{font-size:15px}
      .row{align-items:stretch}
      button{height:52px}
      textarea{min-height:52px}
    }
    @media (prefers-reduced-motion:no-preference){
      .msg .bubble{transition:transform .2s ease, opacity .2s ease}
      .msg.appear .bubble{transform:translateY(6px); opacity:0}
      .msg.show .bubble{transform:none; opacity:1}
    }
  </style>
</head>
<body>
  <div class="wrap">
    <header>Manuel · Simulatore colloquio</header>
    <main class="chat" id="chat" aria-live="polite">
      <!-- messaggi -->
    </main>
    <form class="composer" id="composer">
      <div class="row">
        <textarea id="input" placeholder="Scrivi e premi Invio… (Shift+Invio va a capo)" autocomplete="off"></textarea>
        <button id="send" type="submit">Invia</button>
      </div>
    </form>
  </div>

  <script type="module">
    const ui = {
      chat: document.getElementById('chat'),
      form: document.getElementById('composer'),
      input: document.getElementById('input'),
      send:  document.getElementById('send')
    };

    // --- VisualViewport: adatta alza composer quando appare la tastiera ---
    const vv = window.visualViewport;
    function fitViewport(){
      if(!vv) return;
      const kb = Math.max(0, window.innerHeight - vv.height);
      document.documentElement.style.setProperty('--kb', kb + 'px');
      // se sei vicino al fondo, resta ancorato
      if (isNearBottom()) scrollToBottom();
    }
    if (vv){
      vv.addEventListener('resize', fitViewport);
      vv.addEventListener('scroll', fitViewport);
      fitViewport();
    }

    // --- Autoresize textarea
    function autoresize(){
      ui.input.style.height = 'auto';
      ui.input.style.height = Math.min(ui.input.scrollHeight, window.innerHeight * 0.45) + 'px';
    }
    ui.input.addEventListener('input', autoresize);
    ui.input.addEventListener('focus', () => setTimeout(scrollToBottom, 0));
    autoresize();

    // --- Messaggi UI
    function addMsg(text, who='ai'){
      const wrap = document.createElement('div');
      wrap.className = 'msg ' + (who==='me' ? 'me' : '');
      wrap.innerHTML = '<div class="bubble"></div>';
      const bubble = wrap.querySelector('.bubble');
      bubble.textContent = text;
      wrap.classList.add('appear');
      ui.chat.appendChild(wrap);
      requestAnimationFrame(() => wrap.classList.add('show'));
      if(isNearBottom()) scrollToBottom();
      return bubble;
    }
    function isNearBottom(){
      return (ui.chat.scrollHeight - ui.chat.scrollTop - ui.chat.clientHeight) < 80;
    }
    function scrollToBottom(){
      ui.chat.scrollTop = ui.chat.scrollHeight;
    }

    // --- Intro non invasiva
    function introText(){
      return "Ciao! Sono l’assistente-recruiter di Manuel. Ti farò domande su ruolo, progetti ed esperienza e ti darò feedback sintetici. Indica ruolo target (es. Mechanical Engineer), livello (junior/mid/senior) e lingua: adatto subito il colloquio.";
    }
    addMsg(introText(), 'ai');

    // --- Invio
    ui.form.addEventListener('submit', async (e) => {
      e.preventDefault();
      const text = ui.input.value.trim();
      if(!text) return;
      addMsg(text, 'me');
      ui.input.value='';
      autoresize();
      await streamChat(text);
    });

    async function streamChat(userText){
      ui.send.disabled = true;
      const placeholder = addMsg('…', 'ai');

      try{
        const res = await fetch('/api/chat', {
          method:'POST',
          headers:{ 'Content-Type':'application/json' },
          body: JSON.stringify({ message: userText })
        });

        if(!res.ok || !res.body){
          throw new Error('Connessione non valida');
        }

        // Leggi EventStream "data: <chunk>\n\n" dal backend
        const reader = res.body.getReader();
        const decoder = new TextDecoder('utf-8');
        let buffer = '', done, value;

        placeholder.textContent = ''; // svuota
        while(({done,value} = await reader.read()) && !done){
          buffer += decoder.decode(value, {stream:true});
          let idx;
          // Gestione eventi SSE semplici: "data: ...\n\n"
          while((idx = buffer.indexOf('\n\n')) >= 0){
            const raw = buffer.slice(0, idx).trim();
            buffer = buffer.slice(idx + 2);
            if(raw.startsWith('data:')){
              const chunk = raw.slice(5).trim();
              if (chunk === '[DONE]') { break; }
              placeholder.textContent += chunk;
              if(isNearBottom()) scrollToBottom();
            }
          }
        }
      }catch(err){
        console.error(err);
        addMsg('Errore di connessione. Riprova.', 'ai');
      }finally{
        ui.send.disabled = false;
      }
    }
  </script>
</body>
</html>

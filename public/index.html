<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,user-scalable=no" />
  <title>Chat Manuel AI</title>
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body { background: #f8f9fa; color: #333; font-family: sans-serif; display: flex; justify-content: center; align-items: center; height: 100vh; padding: 16px; }
    .chat-container { background: #fff; width: 100%; max-width: 600px; height: 90vh; display: flex; flex-direction: column; border-radius: 8px; box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1); overflow: hidden; }
    .messages { flex: 1; overflow-y: auto; padding: 16px; display: flex; flex-direction: column; gap: 8px; }
    .message { padding: 10px 14px; border-radius: 16px; max-width: 70%; word-wrap: break-word; line-height: 1.4; }
    .message.user { align-self: flex-end; background: #0d6efd; color: white; border-bottom-right-radius: 0; }
    .message.bot { align-self: flex-start; background: #e9ecef; color: #212529; border-bottom-left-radius: 0; }
    .input-area { display: flex; padding: 12px; background: #f5f5f5; border-top: 1px solid #ddd; }
    .input-area input { flex: 1; padding: 12px; font-size: 1em; border: 1px solid #ccc; border-radius: 20px; outline: none; }
    .input-area button { margin-left: 8px; padding: 12px 18px; background: #0d6efd; color: white; border: none; border-radius: 20px; font-size: 1em; cursor: pointer; transition: background 0.2s; }
    .input-area button:hover { background: #025ce2; }
    @media (max-width: 600px) {
      .chat-container { width: 100%; height: 100vh; border-radius: 0; }
      .messages { padding: 12px; }
      .message { max-width: 90%; }
      .input-area { flex-direction: column; gap: 8px; }
      .input-area button { margin-left: 0; }
    }
  </style>
</head>
<body>
  <div class="chat-container">
    <div class="messages" id="messages">
      <div class="message bot" id="welcome-message">
        In un mondo dove le intelligenze artificiali uniformano, il mio creatore ha scelto di distinguersi con l’AI. Sono Manuel Assistant: posso attingere ai suoi ricordi per risposte personalizzate. Chiedimi ciò che vuoi — prometto che non mentirò.
      </div>
    </div>
    <div class="input-area">
      <input type="text" id="user-input" placeholder="Scrivi un messaggio..." autocomplete="off" />
      <button id="send-button">Invia</button>
    </div>
  </div>

  <script>
  (function(){
    // Se hai impostato redirect in Netlify con status=200:
    const API_PATH = "/api/gptHandler";
    // Se no, usa direttamente la path:
    // const API_PATH = "/.netlify/functions/gptHandler";

    const messages = document.getElementById("messages");
    const input = document.getElementById("user-input");
    const sendBtn = document.getElementById("send-button");

    function appendMessage(text, role) {
      const div = document.createElement("div");
      div.className = "message " + role;
      div.textContent = text;
      messages.appendChild(div);
      messages.scrollTop = messages.scrollHeight;
      return div;
    }

    async function sendMessage(txt) {
      appendMessage(txt, "user");
      input.value = "";
      input.disabled = true;
      sendBtn.disabled = true;

      const botDiv = appendMessage("", "bot");

      try {
        const resp = await fetch(API_PATH, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ message: txt })
        });

        if (!resp.body) throw new Error("Streaming non disponibile");

        const reader = resp.body.getReader();
        const decoder = new TextDecoder();
        let buffer = "", finalText = "";

        while (true) {
          const { done, value } = await reader.read();
          if (done) break;
          buffer += decoder.decode(value, { stream: true });
          const parts = buffer.split("\n\n");
          buffer = parts.pop();

          for (const part of parts) {
            if (!part.startsWith("data:")) continue;
            const chunk = part.slice(5).trim();
            if (chunk === "[END]") {
              botDiv.textContent = finalText.trim();
              throw null;
            }
            else if (chunk === "[ERRORE]") {
              botDiv.textContent = "Errore interno AI.";
              throw null;
            }
            else {
              finalText += chunk;
              botDiv.textContent = finalText;
              messages.scrollTop = messages.scrollHeight;
            }
          }
        }
      } catch (e) {
        if (e) console.error("Fetch error:", e);
      } finally {
        input.disabled = false;
        sendBtn.disabled = false;
        input.focus();
      }
    }

    sendBtn.addEventListener("click", () => {
      const txt = input.value.trim();
      if (txt) sendMessage(txt);
    });

    input.addEventListener("keydown", e => {
      if (e.key === "Enter") sendBtn.click();
    });
  })();
  </script>
</body>
</html>

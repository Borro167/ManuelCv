-<!doctype html>
<html lang="it" data-theme="dark">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0">
  <title>Manuel Assistant · Fullscreen</title>
  <style>
    :root{
      --bg:#0b0f1a; --surface:#11182b; --surface-2:#1a2340;
      --text:#e8ecf8; --muted:#a8b0c8;
      --primary:#7ea2ff; --accent:#9c86ff;
      --border:rgba(255,255,255,.08); --shadow:0 14px 38px rgba(0,0,0,.45);
      --bubble-mine:#24305a; --bubble-theirs:#171f39;
      --pad-inline: clamp(10px, 3vw, 24px);
    }
    [data-theme="light"]{
      --bg:#f6f8ff; --surface:#ffffff; --surface-2:#f0f3ff;
      --text:#0b0f1a; --muted:#445; --border:rgba(0,0,0,.08);
      --bubble-mine:#e9edff; --bubble-theirs:#f5f7ff;
    }
    *{box-sizing:border-box}
    html,body{height:100%;margin:0;background:var(--bg);color:var(--text);font-family:ui-sans-serif,system-ui,Segoe UI,Roboto,Helvetica,Arial}
    body{overscroll-behavior-y: contain;}

    /* App full-viewport anche su mobile (100dvh + fix iOS) */
    .app{height:calc(var(--vh, 1vh) * 100);display:flex;flex-direction:column}

    /* Area messaggi a tutta larghezza/altezza */
    .messages{flex:1 1 auto;overflow:auto;padding:12px var(--pad-inline);display:flex;flex-direction:column;gap:12px;scroll-behavior:smooth}

    /* Bolle */
    .bubble{padding:12px 14px;border-radius:14px;max-width:min(900px, 92vw);line-height:1.4;box-shadow:0 8px 24px rgba(0,0,0,.25)}
    .me{align-self:flex-end;background:var(--bubble-mine)}
    .bot{align-self:flex-start;background:var(--bubble-theirs)}

    /* Composer fisso in fondo, con safe-area iOS */
    .composer{display:flex;gap:10px;align-items:end;padding:12px var(--pad-inline);background:var(--surface-2);border-top:1px solid var(--border)}
    .composer-inner{width:100%;display:flex;gap:10px}
    textarea{flex:1;resize:none;min-height:44px;max-height:33dvh;border-radius:12px;padding:10px 12px;background:transparent;outline:none;color:var(--text);border:1px solid var(--border)}
    .btn{display:inline-flex;align-items:center;gap:8px;padding:10px 14px;border-radius:12px;background:linear-gradient(135deg,var(--primary),var(--accent));border:none;color:#fff;font-weight:700;cursor:pointer;box-shadow:var(--shadow)}

    /* Status bar */
    .mini{display:grid;grid-template-columns:1fr auto;align-items:center;gap:12px;padding:10px var(--pad-inline) max(10px, env(safe-area-inset-bottom));color:var(--muted);font-size:.95em;border-top:1px solid var(--border);background:color-mix(in oklab, var(--surface) 90%, transparent)}
    .mini-left,.mini-right{display:flex;align-items:center;gap:10px;flex-wrap:wrap}
    .chip{opacity:.9}

    /* Levetta stile iPhone */
    .ios-toggle{display:inline-flex;align-items:center;gap:10px}
    .ios-toggle input{position:absolute;opacity:0;width:0;height:0}
    .ios-toggle label{
      position:relative;width:56px;height:32px;background:#6b7280;border-radius:999px;cursor:pointer;
      transition:.2s ease background;border:1px solid var(--border)
    }
    .ios-toggle label::after{
      content:"";position:absolute;top:50%;transform:translateY(-50%);left:4px;width:24px;height:24px;border-radius:50%;
      background:#fff;box-shadow:0 2px 6px rgba(0,0,0,.25);transition:.2s ease left
    }
    .ios-toggle input:checked + label{background:linear-gradient(135deg,var(--primary),var(--accent))}
    .ios-toggle input:checked + label::after{left:28px}

    /* Mobile tweaks */
    @media (max-width:700px){
      .bubble{max-width:92%}
      .mini{grid-template-columns:1fr;gap:8px}
      .chip{font-size:.92em}
    }
    @media print{
      .composer,.mini{display:none!important}
      .messages{height:auto}
      .bubble{page-break-inside:avoid}
    }
  </style>
</head>
<body>
  <div class="app">
    <div id="messages" class="messages"></div>

    <div class="composer">
      <div class="composer-inner">
        <textarea id="input" rows="1" placeholder="Scrivi un messaggio e premi Invio..."></textarea>
        <button id="send" class="btn">Invia</button>
      </div>
    </div>

    <div class="mini">
      <div class="mini-left">
        <span id="netStatus" class="chip">Server: sconosciuto</span>
        <span class="chip">Thread: <span id="threadChip">—</span></span>
      </div>
      <div class="mini-right">
        <span class="chip">Tono</span>
        <div class="ios-toggle">
          <input type="checkbox" id="toneSwitch" aria-label="Tono formale">
          <label for="toneSwitch"></label>
          <span id="toneLabel" class="chip">Informale</span>
        </div>
      </div>
    </div>
  </div>

  <script>
    // Fix 100vh su mobile
    const setVh = () => {
      const vh = window.innerHeight * 0.01;
      document.documentElement.style.setProperty('--vh', `${vh}px`);
    };
    window.addEventListener('resize', setVh);
    window.addEventListener('orientationchange', setVh);
    setVh();

    const el = {
      messages: document.getElementById('messages'),
      input: document.getElementById('input'),
      send: document.getElementById('send'),
      netStatus: document.getElementById('netStatus'),
      toneSwitch: document.getElementById('toneSwitch'),
      toneLabel: document.getElementById('toneLabel'),
      threadChip: document.getElementById('threadChip'),
    };

    let threadId = localStorage.getItem('threadId') || null;
    const START = "Sono l’assistente di Manuel. Ho accesso ai suoi ricordi: desideri sapere qualcosa su di lui?";
    const DEFAULT_TONE = localStorage.getItem('tone') || 'informale';

    // Inizializza levetta + etichetta
    (function initTone(){
      const isFormale = DEFAULT_TONE === 'formale';
      if (el.toneSwitch) el.toneSwitch.checked = isFormale;
      if (el.toneLabel) el.toneLabel.textContent = isFormale ? 'Formale' : 'Informale';
    })();

    function getBehavior(t){
      if(t==='formale') return 'Rispondi in italiano con tono formale e professionale. Dai del Lei. Evita emoji. Frasi complete, chiare e sintetiche. Non spiegare il funzionamento dell\\'assistente. Usa la memoria attiva di Manuel quando pertinente.';
      return 'Rispondi in italiano con tono informale e amichevole. Dai del tu. Niente preamboli. Frasi brevi e pratiche. Emoji poche e opzionali. Usa la memoria attiva di Manuel quando pertinente.';
    }

    document.addEventListener('change', (e) => {
      if (e.target && e.target.id === 'toneSwitch') {
        const mode = e.target.checked ? 'formale' : 'informale';
        localStorage.setItem('tone', mode);
        if (el.toneLabel) el.toneLabel.textContent = e.target.checked ? 'Formale' : 'Informale';
      }
    });

    function addBubble(text, who="bot"){
      const b = document.createElement('div');
      b.className = 'bubble ' + (who === 'me' ? 'me' : 'bot');
      b.innerHTML = text.replace(/\n/g,'<br>');
      el.messages.appendChild(b);
      el.messages.scrollTop = el.messages.scrollHeight;
      return b;
    }
    function addThinking(){
      const b = document.createElement('div');
      b.className = 'bubble bot';
      b.textContent = '…';
      el.messages.appendChild(b);
      el.messages.scrollTop = el.messages.scrollHeight;
      return b;
    }
    function autosize(){
      el.input.style.height='auto';
      const maxPx = Math.round(window.innerHeight * 0.33);
      el.input.style.height=Math.min(el.input.scrollHeight, maxPx)+'px';
    }

    if(!localStorage.getItem('greeted')){
      addBubble(START,'bot');
      localStorage.setItem('greeted','1');
    }

    // Ping server status
    (async()=>{
      try{const r=await fetch('/.netlify/functions/gptHandler',{method:'OPTIONS'}); el.netStatus.textContent=r.ok?'Server: online':'Server: offline';}
      catch{el.netStatus.textContent='Server: offline'}
    })();

    el.input.addEventListener('input', autosize);
    el.input.addEventListener('keydown',(e)=>{if(e.key==='Enter'&&!e.shiftKey){e.preventDefault();sendMessage();}});
    el.send.addEventListener('click', sendMessage);

    async function sendMessage(){
      const text = el.input.value.trim();
      if(!text) return;
      el.input.value=''; autosize();
      addBubble(text,'me');
      const thinking = addThinking();
      try{
        const tone = (el.toneSwitch && el.toneSwitch.checked) ? 'formale' : 'informale';
        const res = await fetch('/.netlify/functions/gptHandler',{
          method:'POST',
          headers:{'Content-Type':'application/json'},
          body: JSON.stringify({message:text, threadId, behavior: getBehavior(tone)})
        });
        const data = await res.json();
        thinking.remove();
        if(data?.reply) addBubble(data.reply,'bot'); else addBubble('Risposta vuota dal server.','bot');
        if(data?.threadId && !threadId){
          threadId = data.threadId; localStorage.setItem('threadId', threadId); el.threadChip.textContent = threadId.slice(-6);
        }
      }catch(e){ thinking.remove(); addBubble('Errore di connessione al server. Controlla le variabili Netlify e riprova.','bot'); }
    }
  </script>
</body>
</html>

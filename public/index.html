<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no"/>
  <title>Manuel • Chat AI</title>
  <meta name="color-scheme" content="dark light">
  <meta name="description" content="Chat AI con musica di sottofondo in autoplay, animazioni, export e cronologia locale.">
  <style>
    :root{
      --bg: #0c0f14;
      --panel: #0f141b;
      --panel-2: #121a22;
      --line: #202a36;
      --text: #e8eef5;
      --muted:#9aa4b2;
      --accent:#6ea8fe;
      --accent-2:#a78bfa;
    }
    @media (prefers-color-scheme: light){
      :root{
        --bg:#f4f7fb; --panel:#ffffff; --panel-2:#f8fafc; --line:#e3e8ef;
        --text:#0f172a; --muted:#596579; --accent:#2563eb; --accent-2:#7c3aed;
      }
    }
    *{ box-sizing: border-box }
    html,body{ height:100% }
    body{
      margin:0; background:
        radial-gradient(1200px 800px at 10% -10%, rgba(110,168,254,.18), transparent 40%),
        radial-gradient(1000px 700px at 120% 10%, rgba(167,139,250,.16), transparent 40%),
        var(--bg);
      color:var(--text);
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Inter, Arial, sans-serif;
      display:flex; align-items:center; justify-content:center; padding:14px;
      -webkit-font-smoothing: antialiased; -moz-osx-font-smoothing: grayscale;
    }
    .app{
      width:100%; max-width:960px; height:min(92vh, 980px);
      display:grid; grid-template-rows: auto 1fr auto; gap:12px;
      background: color-mix(in oklab, var(--panel) 94%, transparent);
      border:1px solid color-mix(in oklab, var(--line) 80%, transparent);
      border-radius: 20px; padding:14px;
      box-shadow: 0 10px 40px rgba(0,0,0,.28);
      backdrop-filter: blur(6px);
    }
    .topbar{
      display:flex; align-items:center; gap:10px; justify-content:space-between;
      padding:10px; border:1px solid var(--line); border-radius:14px;
      background:linear-gradient(180deg, color-mix(in oklab, var(--panel) 96%, transparent), var(--panel));
    }
    .brand{ display:flex; gap:10px; align-items:center; font-weight:700 }
    .pulse{ width:10px; height:10px; border-radius:999px; background:var(--accent); box-shadow:0 0 14px var(--accent) }
    .actions{ display:flex; gap:8px; align-items:center }
    .iconbtn{
      display:inline-flex; align-items:center; justify-content:center; gap:8px;
      padding:10px 12px; border-radius:12px; border:1px solid var(--line); cursor:pointer;
      background:linear-gradient(180deg, color-mix(in oklab, var(--panel) 96%, transparent), var(--panel));
      color:var(--text); font-weight:600;
    }
    .messages{
      overflow:auto; padding:10px; display:flex; flex-direction:column; gap:12px;
      scroll-behavior:smooth; background: color-mix(in oklab, var(--panel-2) 100%, transparent);
      border:1px solid var(--line); border-radius:14px;
    }
    .row{ display:flex; gap:8px; align-items:flex-end }
    .avatar{
      width:34px; height:34px; border-radius:999px; flex:none;
      background: radial-gradient(circle at 30% 30%, var(--accent), var(--accent-2));
      border:1px solid var(--line);
    }
    .bubble{
      max-width:78%; padding:12px 14px; border-radius:16px; line-height:1.5;
      background:linear-gradient(180deg, color-mix(in oklab, var(--panel) 94%, transparent), var(--panel));
      border:1px solid var(--line); white-space:pre-wrap; word-break:break-word;
    }
    .me .bubble{ background:linear-gradient(180deg, color-mix(in oklab, var(--accent) 24%, var(--panel)), var(--panel)); border-bottom-right-radius:6px }
    .bot .bubble{ border-bottom-left-radius:6px }
    .sys{ align-self:center; color:var(--muted); font-size:.95rem; padding:8px 10px; border:1px dashed var(--line); border-radius:12px }
    .meta{ display:flex; gap:10px; align-items:center; color:var(--muted); font-size:.8rem; margin-top:4px }
    .copy{ border:none; background:transparent; color:var(--muted); cursor:pointer; font-size:.85rem; padding:2px 6px; border-radius:8px }
    .copy:hover{ color:var(--text); background: color-mix(in oklab, var(--panel) 90%, transparent) }
    .thinking{ display:inline-flex; gap:4px; align-items:center; color:var(--muted) }
    .thinking i{ width:6px; height:6px; border-radius:999px; background:currentColor; opacity:.4; animation:b 1.2s infinite }
    .thinking i:nth-child(2){animation-delay:.15s} .thinking i:nth-child(3){animation-delay:.30s}
    @keyframes b{ 0%,80%,100%{transform:translateY(0);opacity:.35} 40%{transform:translateY(-4px);opacity:.85} }
    .input{
      display:flex; gap:10px; align-items:flex-end; padding:8px; border-radius:14px;
      background:linear-gradient(180deg, color-mix(in oklab, var(--panel) 96%, transparent), var(--panel));
      border:1px solid var(--line);
    }
    textarea{
      flex:1; resize:none; min-height:44px; max-height:160px; padding:12px 14px; border-radius:12px; outline:none;
      border:1px solid transparent; background:color-mix(in oklab, var(--panel) 94%, transparent); color:var(--text); font-size:1rem;
    }
    .send{ padding:12px 16px; border-radius:12px; border:1px solid var(--line); background:linear-gradient(180deg, color-mix(in oklab, var(--accent) 50%, var(--panel)), var(--panel)); color:#fff; font-weight:700; cursor:pointer }
    .stop{ padding:12px 12px; border-radius:12px; border:1px solid var(--line); background:linear-gradient(180deg, color-mix(in oklab, #ef4444 40%, var(--panel)), var(--panel)); color:#fff; font-weight:700; cursor:pointer }
    .drop{
      position:fixed; inset:0; display:none; place-items:center; background:rgba(0,0,0,.35); z-index:50;
      color:#fff; font-size:1.2rem; text-align:center; padding:20px;
    }
    .drop.active{ display:grid }
    .toast{
      position:fixed; bottom:12px; left:50%; transform:translateX(-50%);
      background:linear-gradient(180deg, color-mix(in oklab, var(--panel) 92%, transparent), var(--panel));
      border:1px solid var(--line); border-radius:10px; padding:10px 12px; color:var(--muted); font-size:.92rem;
    }
  </style>
</head>
<body>
  <main class="app" aria-label="Chat Manuel AI">
    <header class="topbar">
      <div class="brand"><span class="pulse" aria-hidden="true"></span> Manuel • Assistente</div>
      <div class="actions">
        <span id="status" class="hint">Pronto</span>
        <button id="newChat" class="iconbtn" title="Nuova chat">Nuova chat</button>
        <button id="exportTxt" class="iconbtn" title="Esporta .txt">Esporta</button>
      </div>
    </header>

    <section class="messages" id="messages" aria-live="polite" aria-busy="false">
      <div class="sys" id="welcome">Benvenuto! Questa è la chat di Manuel: risposte rapide, chiare e senza HTML attivo. Musica di sottofondo attiva automaticamente (se il browser lo consente).</div>
    </section>

    <footer class="input">
      <textarea id="box" placeholder="Scrivi un messaggio… (Invio invia • Shift+Invio va a capo)" autocomplete="off"></textarea>
      <button id="stop" class="stop" style="display:none">Stop</button>
      <button id="send" class="send">Invia</button>
    </footer>
  </main>

  <!-- Musica di sottofondo: parte da sola (autoplay). Metti il tuo file in public/music/autoplay.mp3 -->
  <audio id="bgm" src="music/autoplay.mp3" preload="auto" loop playsinline autoplay></audio>

  <div class="drop" id="drop">
    <div>
      <strong>Rilascia qui il tuo MP3</strong><br/>
      Sostituirò la musica di sottofondo e partirà subito.
    </div>
  </div>
  <div class="toast" id="toast" style="display:none"></div>

  <script>
    const $ = (s)=>document.querySelector(s);
    const messages = $("#messages");
    const box = $("#box");
    const send = $("#send");
    const stopBtn = $("#stop");
    const statusEl = $("#status");
    const newChat = $("#newChat");
    const exportTxt = $("#exportTxt");
    const bgm = $("#bgm");
    const drop = $("#drop");
    const toast = $("#toast");

    const FN_URL = "/.netlify/functions/gptHandler";

    // ---------- UI helpers ----------
    function showToast(text, ms=2000){
      toast.textContent = text;
      toast.style.display = "block";
      clearTimeout(showToast._t);
      showToast._t = setTimeout(()=> toast.style.display = "none", ms);
    }
    function fmtTime(d=new Date()){
      return d.toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'});
    }

    function addRow(role, text){
      const row = document.createElement("div");
      row.className = "row " + (role === "user" ? "me" : "bot");
      const avatar = document.createElement("div");
      avatar.className = "avatar";
      row.appendChild(avatar);
      const wrap = document.createElement("div");
      const bubble = document.createElement("div");
      bubble.className = "bubble";
      bubble.textContent = text; // ← NO innerHTML: l'AI non può iniettare HTML
      wrap.appendChild(bubble);
      const meta = document.createElement("div");
      meta.className = "meta";
      const time = document.createElement("span");
      time.textContent = fmtTime();
      const copy = document.createElement("button");
      copy.className = "copy";
      copy.textContent = "Copia";
      copy.addEventListener("click", ()=> navigator.clipboard.writeText(text).then(()=> showToast("Copiato")));
      meta.appendChild(time);
      meta.appendChild(copy);
      wrap.appendChild(meta);
      row.appendChild(wrap);
      messages.appendChild(row);
      messages.scrollTop = messages.scrollHeight;
      return bubble;
    }

    function addThinking(){
      const row = document.createElement("div");
      row.className = "row bot";
      const avatar = document.createElement("div");
      avatar.className = "avatar";
      row.appendChild(avatar);
      const bubble = document.createElement("div");
      bubble.className = "bubble";
      bubble.innerHTML = '<span class="thinking"><i></i><i></i><i></i></span> Sto pensando…';
      row.appendChild(bubble);
      messages.appendChild(row);
      messages.scrollTop = messages.scrollHeight;
      return row;
    }

    // ---------- Cronologia (LocalStorage) ----------
    const HISTORY_KEY = "manuel_chat_history_v2";
    function loadHistory(){
      try{
        const arr = JSON.parse(localStorage.getItem(HISTORY_KEY) || "[]");
        arr.forEach(item => addRow(item.role, item.text));
      }catch{}
    }
    function saveToHistory(role, text){
      try{
        const arr = JSON.parse(localStorage.getItem(HISTORY_KEY) || "[]");
        arr.push({role, text, t: Date.now()});
        localStorage.setItem(HISTORY_KEY, JSON.stringify(arr.slice(-200)));
      }catch{}
    }
    function clearHistory(){
      localStorage.removeItem(HISTORY_KEY);
      messages.innerHTML = '<div class="sys" id="welcome">Benvenuto! Questa è la chat di Manuel: risposte rapide, chiare e senza HTML attivo. Musica di sottofondo attiva automaticamente (se il browser lo consente).</div>';
    }

    // ---------- Invio / Stop ----------
    let controller = null;
    async function sendMessage(){
      const text = box.value.trim();
      if(!text) return;
      addRow("user", text);
      saveToHistory("user", text);
      box.value = ""; box.style.height = "44px";
      box.disabled = true; send.disabled = true; statusEl.textContent = "Invio in corso…";
      stopBtn.style.display = "inline-block";

      const thinking = addThinking();
      controller = new AbortController();
      try{
        const res = await fetch(FN_URL, {
          method:"POST",
          headers:{ "Content-Type":"application/json" },
          body: JSON

<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no"/>
  <title>Manuel • Assistente</title>
  <meta name="color-scheme" content="light dark">
  <style>
    :root{
      --bg: #0b0d10;
      --panel: #12161b;
      --muted: #9aa4b2;
      --text: #e8eef5;
      --accent: #6ea8fe;
      --accent-2:#8b5cf6;
      --danger:#ef4444;
      --radius:16px;
    }
    @media (prefers-color-scheme: light){
      :root{ --bg:#f3f5f8; --panel:#ffffff; --text:#0f172a; --muted:#5b6472; --accent:#2563eb; --accent-2:#7c3aed;}
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0; background:
      radial-gradient(1200px 800px at 10% -10%, rgba(110,168,254,.20), transparent 40%),
      radial-gradient(1000px 700px at 110% 10%, rgba(139,92,246,.18), transparent 40%),
      var(--bg);
      color:var(--text); display:flex; align-items:center; justify-content:center; padding:16px;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Inter, Arial, sans-serif;
    }
    .app{
      width:100%; max-width:820px; height:clamp(560px, 90vh, 920px);
      display:grid; grid-template-rows: auto 1fr auto; gap:10px;
      backdrop-filter: blur(6px); background: color-mix(in oklab, var(--panel) 92%, transparent);
      border:1px solid color-mix(in oklab, var(--panel) 70%, #000 30%);
      border-radius:20px; box-shadow:0 10px 40px rgba(0,0,0,.25); padding:14px;
    }
    .topbar{
      display:flex; align-items:center; justify-content:space-between; gap:10px;
      padding:6px 10px; border-radius:12px;
      background:linear-gradient(180deg, color-mix(in oklab, var(--panel) 96%, transparent), var(--panel));
      border:1px solid color-mix(in oklab, var(--panel) 60%, #000 40%);
    }
    .brand{display:flex; align-items:center; gap:10px; font-weight:600}
    .dot{width:10px; height:10px; border-radius:999px; background:var(--accent); box-shadow:0 0 12px var(--accent)}
    .hint{color:var(--muted); font-size:.92rem}
    .messages{
      overflow:auto; padding:10px; display:flex; flex-direction:column; gap:10px;
      scroll-behavior:smooth;
    }
    .bubble{
      max-width:80%; padding:12px 14px; border-radius:18px; line-height:1.45;
      border:1px solid color-mix(in oklab, var(--panel) 64%, #000 36%);
      background:linear-gradient(180deg, color-mix(in oklab, var(--panel) 92%, transparent), var(--panel));
      white-space:pre-wrap; word-break:break-word;
    }
    .me{ align-self:flex-end; border-bottom-right-radius:6px; background:linear-gradient(180deg, color-mix(in oklab, var(--accent) 22%, var(--panel)), var(--panel)); }
    .bot{ align-self:flex-start; border-bottom-left-radius:6px;}
    .sys{ align-self:center; font-size:.92rem; color:var(--muted); border-style:dashed; }
    .thinking{ display:inline-flex; gap:4px; align-items:center; color:var(--muted); }
    .thinking i{ width:6px; height:6px; border-radius:999px; background:currentColor; opacity:.4; animation:b 1.2s infinite }
    .thinking i:nth-child(2){animation-delay:.15s} .thinking i:nth-child(3){animation-delay:.30s}
    @keyframes b{ 0%,80%,100%{transform:translateY(0);opacity:.35} 40%{transform:translateY(-4px);opacity:.85}}
    .input{
      display:flex; gap:10px; align-items:flex-end; padding:8px; border-radius:14px;
      background:linear-gradient(180deg, color-mix(in oklab, var(--panel) 96%, transparent), var(--panel));
      border:1px solid color-mix(in oklab, var(--panel) 60%, #000 40%);
    }
    textarea{
      flex:1; resize:none; min-height:44px; max-height:140px; padding:12px 14px; border-radius:12px; outline:none; border:1px solid transparent;
      background:color-mix(in oklab, var(--panel) 92%, transparent); color:var(--text); font-size:1rem;
    }
    button{
      padding:12px 16px; border-radius:12px; border:1px solid color-mix(in oklab, var(--accent) 30%, #000 70%);
      background:linear-gradient(180deg, color-mix(in oklab, var(--accent) 55%, var(--panel)), var(--panel));
      color:#fff; font-weight:600; cursor:pointer; transition:transform .05s ease;
    }
    button:disabled{ opacity:.5; cursor:not-allowed }
    button:active{ transform:translateY(1px) }
  </style>
</head>
<body>
  <main class="app" aria-label="Chat Manuel Assistant">
    <header class="topbar">
      <div class="brand"><span class="dot" aria-hidden="true"></span> Manuel • Assistente</div>
      <div class="hint" id="status">Pronto</div>
    </header>

    <section class="messages" id="messages" aria-live="polite" aria-busy="false">
      <div class="bubble sys">Benvenuto! Sono l’assistente personale di Manuel. Fai una domanda: risponderò in modo chiaro e senza fronzoli.</div>
    </section>

    <footer class="input">
      <textarea id="box" placeholder="Scrivi un messaggio… (Invio per inviare, Shift+Invio per andare a capo)" autocomplete="off"></textarea>
      <button id="send">Invia</button>
    </footer>
  </main>

  <script>
    const $ = (s)=>document.querySelector(s);
    const messages = $("#messages");
    const box = $("#box");
    const send = $("#send");
    const statusEl = $("#status");

    const FN_URL = "/.netlify/functions/gptHandler"; // Netlify

    function addBubble(text, who="bot"){
      const div = document.createElement("div");
      div.className = `bubble ${who}`;
      // NIENTE innerHTML per evitare che l'HTML interferisca con la chat:
      div.textContent = text;
      messages.appendChild(div);
      messages.scrollTop = messages.scrollHeight;
      return div;
    }

    function addThinking(){
      const div = document.createElement("div");
      div.className = "bubble bot";
      div.innerHTML = '<span class="thinking"><i></i><i></i><i></i></span> Sto pensando…';
      messages.appendChild(div);
      messages.scrollTop = messages.scrollHeight;
      return div;
    }

    async function sendMessage(){
      const text = box.value.trim();
      if(!text) return;
      addBubble(text, "me");
      box.value = "";
      box.style.height = "44px";
      box.disabled = true; send.disabled = true; statusEl.textContent = "Invio in corso…";
      const th = addThinking();

      try{
        const res = await fetch(FN_URL, {
          method:"POST",
          headers:{ "Content-Type":"application/json" },
          body: JSON.stringify({ message: text }),
        });

        if(!res.ok){
          th.remove();
          addBubble(`Errore server (${res.status}). Riprova tra poco.`, "bot");
        }else{
          const data = await res.json();
          th.remove();
          addBubble(data.reply || "Nessuna risposta ricevuta.", "bot");
        }
      }catch(e){
        th.remove();
        addBubble("Errore di connessione. Controlla rete o riprova.", "bot");
      }finally{
        box.disabled = false; send.disabled = false; statusEl.textContent = "Pronto"; box.focus();
      }
    }

    // UI niceties
    box.addEventListener("input", ()=>{
      box.style.height = "44px";
      box.style.height = Math.min(box.scrollHeight, 140)+"px";
    });

    box.addEventListener("keydown",(e)=>{
      if(e.key==="Enter" && !e.shiftKey){ e.preventDefault(); sendMessage(); }
    });
    send.addEventListener("click", sendMessage);
  </script>
</body>
</html>

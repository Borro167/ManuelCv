<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,user-scalable=no" />
  <title>Chat Manuel Assistant</title>
  <style>
    *{box-sizing:border-box;}
    body{margin:0;font-family:Segoe UI,Tahoma,Geneva,Verdana,sans-serif;background:#f2f2f2;display:flex;justify-content:center;align-items:center;height:100vh;}
    .chat-container{display:flex;flex-direction:column;width:100%;max-width:600px;height:90vh;border:1px solid #ddd;background:#fff;border-radius:8px;overflow:hidden;box-shadow:0 2px 10px rgba(0,0,0,0.1);}
    .messages{flex:1;padding:16px;overflow-y:auto;display:flex;flex-direction:column;}
    .message{margin-bottom:12px;padding:10px 14px;border-radius:16px;max-width:70%;line-height:1.4;word-wrap:break-word;}
    .message.user{background:#007bff;color:#fff;align-self:flex-end;border-bottom-right-radius:0;}
    .message.bot{background:#e9ecef;color:#333;align-self:flex-start;border-bottom-left-radius:0;}
    .input-area{display:flex;border-top:1px solid #ddd;padding:8px;background:#fafafa;}
    .input-area input{flex:1;padding:10px;border:1px solid #ccc;border-radius:20px;font-size:1em;outline:none;}
    .input-area button{margin-left:8px;padding:10px 16px;border:none;background:#007bff;color:#fff;border-radius:20px;cursor:pointer;font-size:1em;transition:background 0.2s;}
    .input-area button:hover{background:#0056b3;}
    @media(max-width:600px){
      .chat-container{height:100vh;border-radius:0;box-shadow:none;border:none;}
      .messages{padding:12px;}
      .message{font-size:0.95em;max-width:85%;}
      .input-area{flex-direction:column;gap:8px;padding:8px;}
      .input-area input,.input-area button{width:100%;padding:14px;margin:0;font-size:1em;}
      .input-area button{margin-left:0;}
    }
  </style>
</head>
<body>
  <div class="chat-container">
    <div class="messages" id="messages">
      <div class="message bot" id="welcome-message"></div>
    </div>
    <div class="input-area">
      <input type="text" id="user-input" placeholder="Scrivi un messaggio..." autocomplete="off" />
      <button id="send-button">Invia</button>
    </div>
  </div>

  <script>
    const container = document.getElementById('messages');
    const input = document.getElementById('user-input');
    const btn = document.getElementById('send-button');

    document.getElementById('welcome-message').innerHTML =
      'In un mondo dove le intelligenze artificiali tendono ad omologare, il mio padrone ha scelto di distinguersi… usando proprio l’AI.<br>Sono l’assistente personale di Manuel: posso accedere ai suoi ricordi. Chiedimi ciò che vuoi — ti prometto che non mentirò.';

    function appendMessage(txt, cls) {
      const div = document.createElement('div');
      div.classList.add('message', cls);
      div.textContent = txt;
      container.appendChild(div);
      container.scrollTop = container.scrollHeight;
      return div;
    }

    async function handleStream(msg) {
      appendMessage(msg, 'user');
      input.value = '';
      input.disabled = true;
      btn.disabled = true;

      const bot = appendMessage('', 'bot');
      try {
        const res = await fetch('/.netlify/functions/gptHandler', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ message: msg })
        });

        if (!res.body) throw new Error('Streaming non supportato');

        const reader = res.body.getReader();
        const dec = new TextDecoder();
        let text = '', buff = '';

        while (true) {
          const { done, value } = await reader.read();
          if (done) break;
          buff += dec.decode(value, { stream: true });
          const parts = buff.split('\n\n');
          buff = parts.pop();
          for (const line of parts) {
            if (!line.startsWith('data:')) continue;
            const chunk = line.replace(/^data:\s*/, '');
            if (chunk === '[END]') {
              bot.textContent = text.trim();
              input.disabled = false;
              btn.disabled = false;
              input.focus();
              return;
            }
            if (chunk === '[ERRORE]') {
              bot.textContent = 'Errore interno AI.';
              input.disabled = false;
              btn.disabled = false;
              input.focus();
              return;
            }
            text += chunk;
            bot.textContent = text;
            container.scrollTop = container.scrollHeight;
          }
        }
      } catch (e) {
        bot.textContent = "Errore di connessione.";
        input.disabled = false;
        btn.disabled = false;
        input.focus();
      }
    }

    btn.addEventListener('click', () => {
      const txt = input.value.trim();
      if (txt) handleStream(txt);
    });

    input.addEventListener('keydown', e => {
      if (e.key === 'Enter') btn.click();
    });
  </script>
</body>
</html>

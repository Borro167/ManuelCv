<!doctype html>
<html lang="it" data-theme="dark">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0" />
  <meta name="color-scheme" content="dark light" />
  <title>Manuel Assistant · Fullscreen</title>
  <style>
    :root{
      --bg:#0b0f1a; --surface:#11182b; --surface-2:#1a2340;
      --text:#e8ecf8; --muted:#a8b0c8;
      --primary:#7ea2ff; --accent:#9c86ff;
      --border:rgba(255,255,255,.08); --shadow:0 14px 38px rgba(0,0,0,.45);
      --bubble-mine:#24305a; --bubble-theirs:#171f39;
      --pad-inline: clamp(10px, 3vw, 24px);
    }
    [data-theme="light"]{
      --bg:#f6f8ff; --surface:#ffffff; --surface-2:#f0f3ff;
      --text:#0b0f1a; --muted:#445; --border:rgba(0,0,0,.08);
      --bubble-mine:#e9edff; --bubble-theirs:#f5f7ff;
    }
    *{box-sizing:border-box}
    html,body{height:100%;margin:0}
    body{background:var(--bg);color:var(--text);font-family:ui-sans-serif,system-ui,Segoe UI,Roboto,Helvetica,Arial;overscroll-behavior-y:contain}

    .app{height:calc(var(--vh,1vh)*100);display:flex;flex-direction:column}
    .messages{flex:1 1 auto;overflow:auto;padding:12px var(--pad-inline);display:flex;flex-direction:column;gap:12px;scroll-behavior:smooth}
    .bubble{max-width:min(900px,92vw);padding:12px 14px;border-radius:14px;line-height:1.4;box-shadow:0 8px 24px rgba(0,0,0,.25)}
    .me{align-self:flex-end;background:var(--bubble-mine)}
    .bot{align-self:flex-start;background:var(--bubble-theirs)}

    .composer{display:flex;gap:10px;align-items:end;padding:12px var(--pad-inline);background:var(--surface-2);border-top:1px solid var(--border)}
    .composer-inner{width:100%;display:flex;gap:10px}
    textarea{flex:1;resize:none;min-height:44px;max-height:33dvh;padding:10px 12px;color:var(--text);background:transparent;border:1px solid var(--border);border-radius:12px;outline:none}
    .btn{display:inline-flex;align-items:center;gap:8px;padding:10px 14px;color:#fff;background:linear-gradient(135deg,var(--primary),var(--accent));border:none;border-radius:12px;font-weight:700;cursor:pointer;box-shadow:var(--shadow)}
    .btn[disabled]{opacity:.7;cursor:wait}

    .mini{display:grid;grid-template-columns:1fr auto;align-items:center;gap:12px;padding:10px var(--pad-inline) max(10px,env(safe-area-inset-bottom));color:var(--muted);font-size:.95em;border-top:1px solid var(--border);background:color-mix(in oklab, var(--surface) 90%, transparent)}
    .mini-left,.mini-right{display:flex;align-items:center;gap:10px;flex-wrap:wrap}
    .chip{opacity:.9}

    /* switch iPhone */
    .ios-toggle{display:inline-flex;align-items:center;gap:10px}
    .ios-toggle input{position:absolute;opacity:0;width:0;height:0}
    .ios-toggle label{position:relative;width:56px;height:32px;background:#6b7280;border:1px solid var(--border);border-radius:999px;cursor:pointer;transition:.2s ease background}
    .ios-toggle label::after{content:"";position:absolute;top:50%;left:4px;transform:translateY(-50%);width:24px;height:24px;border-radius:50%;background:#fff;box-shadow:0 2px 6px rgba(0,0,0,.25);transition:.2s ease left}
    .ios-toggle input:checked + label{background:linear-gradient(135deg,var(--primary),var(--accent))}
    .ios-toggle input:checked + label::after{left:28px}

    @media (max-width:700px){.bubble{max-width:92%}.mini{grid-template-columns:1fr;gap:8px}.chip{font-size:.92em}}
    @media (prefers-reduced-motion:reduce){*{scroll-behavior:auto}}
    @media print{.composer,.mini{display:none!important}.messages{height:auto}.bubble{page-break-inside:avoid}}
  </style>
</head>
<body>
  <div class="app">
    <div id="messages" class="messages" aria-live="polite"></div>

    <div class="composer">
      <div class="composer-inner">
        <textarea id="input" rows="1" placeholder="Scrivi un messaggio e premi Invio..." autocomplete="off"></textarea>
        <button id="send" class="btn" type="button">Invia</button>
      </div>
    </div>

    <div class="mini">
      <div class="mini-left">
        <span id="netStatus" class="chip" role="status">Server: sconosciuto</span>
        <span class="chip">Thread: <span id="threadChip">—</span></span>
      </div>
      <div class="mini-right">
        <span class="chip" id="toneText">Tono</span>
        <div class="ios-toggle">
          <input type="checkbox" id="toneSwitch" aria-labelledby="toneText" />
          <label for="toneSwitch"></label>
          <span id="toneLabel" class="chip">Informale</span>
        </div>
      </div>
    </div>
  </div>

  <script>
    "use strict";

    // --- viewport fix mobile
    const setVh = () => {
      const vh = window.innerHeight * 0.01;
      document.documentElement.style.setProperty("--vh", `${vh}px`);
    };
    addEventListener("resize", setVh);
    addEventListener("orientationchange", setVh);
    setVh();

    // --- DOM refs
    const el = {
      messages: document.getElementById("messages"),
      input: document.getElementById("input"),
      send: document.getElementById("send"),
      netStatus: document.getElementById("netStatus"),
      toneSwitch: document.getElementById("toneSwitch"),
      toneLabel: document.getElementById("toneLabel"),
      threadChip: document.getElementById("threadChip"),
    };

    // --- state
    let threadId = localStorage.getItem("threadId") || null;
    let tone = localStorage.getItem("tone") || "informale"; // formale/informale
    const history = JSON.parse(localStorage.getItem("history") || "[]"); // [{role,content}]

    // --- tone init
    (function initTone(){
      const isFormale = tone === "formale";
      el.toneSwitch.checked = isFormale;
      el.toneLabel.textContent = isFormale ? "Formale" : "Informale";
    })();

    // --- behavior (passato come additional_instructions)
    function getBehavior(t) {
      const hard = [
        "Massimo 15 parole. Non ripetere. Non spiegare operazioni interne.",
        "Usa solo dati realmente caricati/ricordi disponibili; non inventare.",
        "Mai citare nomi di file o sorgenti.",
        "Se deduci reparto: HR→risultati; Tecnico→dettagli tecnici e metriche.",
        "Domande generiche: elenca 2–3 fatti specifici.",
        "Se sarebbe vaga: chiedi precisione.",
        "Se mancano info: usa messaggio di fallback."
      ].join("\n");
      return (t === "formale")
        ? `Sei Manuel, candidato a un colloquio. Prima persona.\nTono formale, dia del Lei. Diretto e sincero.\n${hard}`
        : `Sei Manuel, candidato a un colloquio. Prima persona.\nTono informale, dai del tu. Diretto e sincero.\n${hard}`;
    }

    // --- intro message (mostrato e salvato come contesto)
    function introByTone(t){
      return t === "formale"
        ? "Buongiorno, sono l’assistente professionale di Manuel; lo sostituisco virtualmente per un pre‑colloquio. Mi dica cosa le serve."
        : "Ciao, sono l’assistente professionale di Manuel; lo sostituisco virtualmente per un pre‑colloquio. Dimmi cosa ti serve.";
    }

    // --- history utils (per summary a ogni chiamata)
    function truncate(s, n){ return s.length>n ? s.slice(0, n-1) + "…" : s; }
    function buildSummary(){
      const recent = history.slice(-12);
      const parts = recent.map(h => (h.role==="user"?"U: ":"M: ") + truncate(h.content, 180));
      return parts.join(" | ").slice(0, 1500);
    }
    function saveHistory(){ localStorage.setItem("history", JSON.stringify(history.slice(-40))); }

    // --- UI helpers
    function addBubble(text, who="bot"){
      const b = document.createElement("div");
      b.className = "bubble " + (who==="me"?"me":"bot");
      b.innerHTML = String(text).replace(/\n/g,"<br>");
      el.messages.appendChild(b);
      el.messages.scrollTop = el.messages.scrollHeight;
      return b;
    }
    function addThinking(){
      const b = document.createElement("div");
      b.className = "bubble bot";
      b.textContent = "…";
      el.messages.appendChild(b);
      el.messages.scrollTop = el.messages.scrollHeight;
      return b;
    }
    function autosize(){
      el.input.style.height = "auto";
      const maxPx = Math.round(window.innerHeight * 0.33);
      el.input.style.height = Math.min(el.input.scrollHeight, maxPx) + "px";
    }

    // --- ping server (CORS/online)
    async function pingServer(){
      try {
        const res = await fetch('/.netlify/functions/gptHandler', { method:'OPTIONS' });
        el.netStatus.textContent = res.ok ? 'Server: pronto' : 'Server: non raggiungibile';
      } catch {
        el.netStatus.textContent = 'Server: non raggiungibile';
      }
    }

    // --- init intro (solo se non già presente in history)
    (function initIntro(){
      if (!history.length) {
        const intro = introByTone(tone);
        addBubble(intro, "bot");
        history.push({ role:"assistant", content:intro });
        saveHistory();
      }
    })();

    // --- send logic
    async function sendMessage(){
      const text = el.input.value.trim();
      if (!text) return;

      // UI
      addBubble(text, 'me');
      history.push({ role:'user', content:text });
      saveHistory();
      el.input.value = '';
      autosize();
      el.send.disabled = true;
      const thinking = addThinking();

      try {
        const res = await fetch('/.netlify/functions/gptHandler', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            message: text,
            threadId,
            behavior: getBehavior(tone),
            tone,
            summary: buildSummary(),
          })
        });

        el.netStatus.textContent = res.ok ? 'Server: OK' : `Server: ${res.status}`;
        const data = await res.json();
        thinking.remove();

        if (data?.reply){
          addBubble(data.reply, 'bot');
          history.push({ role:'assistant', content:data.reply });
          saveHistory();
        } else {
          addBubble('Risposta vuota dal server.', 'bot');
        }

        if (data?.threadId && !threadId){
          threadId = data.threadId;
          localStorage.setItem('threadId', threadId);
          el.threadChip.textContent = threadId.slice(-6);
        }
      } catch (e) {
        thinking.remove();
        addBubble('Errore di connessione al server. Controlla le variabili Netlify e riprova.', 'bot');
      } finally {
        el.send.disabled = false;
      }
    }

    // --- events
    el.send.addEventListener('click', sendMessage);
    el.input.addEventListener('keydown', (ev) => {
      if (ev.key === 'Enter' && !ev.shiftKey) { ev.preventDefault(); sendMessage(); }
    });
    el.input.addEventListener('input', autosize);
    autosize();

    el.toneSwitch.addEventListener('change', () => {
      tone = el.toneSwitch.checked ? 'formale' : 'informale';
      el.toneLabel.textContent = el.toneSwitch.checked ? 'Formale' : 'Informale';
      localStorage.setItem('tone', tone);
      addBubble(`Tono impostato su ${tone}.`, 'bot');
    });

    // show last 6 chars if thread already exists
    if (threadId) { el.threadChip.textContent = threadId.slice(-6); }

    // try to ping server once on load
    pingServer();
  </script>
</body>
</html>

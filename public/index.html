<!doctype html>
<html lang="it" data-theme="dark">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <meta name="color-scheme" content="dark light" />
  <title>Assistente di Manuel — Chat</title>
  <style>
    /* ---- THEME ---- */
    :root{
      --bg:#0b0f1a;--bg2:#121a2f;--card:#0f1629cc;--card2:#121a2fcc;
      --text:#e9eefc;--muted:#aab3cd;--primary:#86a6ff;--accent:#b38bff;
      --ok:#35d39e;--warn:#ffb64d;--border:1px solid rgba(255,255,255,.08);
      --shadow:0 10px 40px rgba(0,0,0,.55);--pad:clamp(12px,2vw,20px);
      --radius:18px;--radius-lg:22px;
    }
    :root[data-theme="light"]{
      --bg:#f7f8fe;--bg2:#e8ecff;--card:#ffffffee;--card2:#ffffffcc;
      --text:#0b0f1a;--muted:#4b5678;--primary:#3248ff;--accent:#7a3cff;
      --ok:#0a8f62;--warn:#b86b00;--border:1px solid rgba(0,0,0,.1)
    }

    /* ---- RESET (scoped to app) ---- */
    *{box-sizing:border-box}
    html,body{height:100%;margin:0}
    body{font-family:ui-sans-serif,system-ui,Segoe UI,Roboto,Helvetica,Arial; color:var(--text);
      background:
        radial-gradient(1200px 800px at 10% -10%, #23326b44, transparent),
        radial-gradient(1000px 600px at 100% 0%, #5b3cc744, transparent),
        linear-gradient(160deg, var(--bg), var(--bg2));
      overflow:hidden; /* niente scrollbar di pagina */
    }

    /* ---- APP LAYOUT ---- */
    #app{height:100dvh; display:grid; grid-template-rows:auto 1fr auto;}

    .header{position:sticky; top:0; z-index:10; display:flex; align-items:center; gap:12px;
      padding:10px var(--pad); background:linear-gradient(180deg, var(--card), transparent);
      border-bottom:var(--border); backdrop-filter:saturate(140%) blur(6px)}
    .brand{display:flex; align-items:center; gap:12px}
    .logo{width:32px;height:32px;display:grid;place-items:center;border-radius:10px;
      background:conic-gradient(from 210deg, var(--primary), var(--accent)); color:#0b0f1a;
      font-weight:900; box-shadow:var(--shadow)}
    .title{font-weight:700;letter-spacing:.2px}
    .status{margin-left:auto;display:flex;align-items:center;gap:8px;color:var(--muted);font-size:.9rem}
    .dot{width:8px;height:8px;border-radius:99px;background:var(--ok);box-shadow:0 0 0 3px #35d39e22}
    .dot.warn{background:var(--warn);box-shadow:0 0 0 3px #ffb64d22}

    /* ---- MESSAGES ---- */
    .messages{height:100%; padding:16px var(--pad) 12px; overflow:auto; scroll-behavior:smooth;
      -ms-overflow-style:none; scrollbar-width:none; overscroll-behavior:contain}
    .messages::-webkit-scrollbar{width:0;height:0}

    .stack{max-width:980px; margin:0 auto; display:flex; flex-direction:column; gap:12px}
    .bubble{max-width:85%; padding:12px 14px; border-radius:16px; background:var(--card);
      box-shadow:var(--shadow); line-height:1.4}
    .assistant{align-self:flex-start; border-top-left-radius:6px}
    .user{align-self:flex-end; border-top-right-radius:6px; background:linear-gradient(135deg, #213bff66, #7c3cff66), var(--card)}
    .meta{opacity:.65; font-size:.8rem; margin-top:6px}
    .thinking{opacity:.9; font-style:italic}

    /* ---- COMPOSER ---- */
    .composer{position:sticky; bottom:0; padding:10px var(--pad) calc(env(safe-area-inset-bottom,0) + 10px);
      background:linear-gradient(0deg, var(--card2), transparent 50%); border-top:var(--border)}
    .row{max-width:980px; margin:0 auto; display:flex; gap:10px; align-items:flex-end}
    textarea{flex:1; min-height:44px; max-height:160px; padding:12px 14px; border-radius:14px; border:var(--border);
      background:var(--card); color:var(--text); outline:none; resize:none; line-height:1.35; font-size:16px}
    .send{flex:0 0 auto; height:44px; min-width:44px; padding:0 16px; border-radius:12px; border:none; cursor:pointer;
      background:linear-gradient(135deg, var(--primary), var(--accent)); color:white; font-weight:700; box-shadow:var(--shadow)}
    .send:disabled{opacity:.6; cursor:not-allowed}

    /* ---- SMALL SCREENS ---- */
    @media (max-width: 640px){
      .bubble{max-width:92%}
      .title{font-size:1rem}
      .row{gap:8px}
      textarea{font-size:16px} /* evita zoom su iOS */
    }
  </style>
</head>
<body>
  <div id="app" aria-live="polite">
    <header class="header">
      <div class="brand">
        <div class="logo">M</div>
        <div class="title">Assistente di Manuel</div>
      </div>
      <div class="status"><span class="dot" id="statusDot" aria-hidden="true"></span><span id="statusText">Pronto</span></div>
    </header>

    <main class="messages" id="messages">
      <div class="stack" id="stack"></div>
    </main>

    <form class="composer" id="composer" autocomplete="off">
      <div class="row">
        <label for="input" class="sr-only" style="position:absolute;left:-9999px">Messaggio</label>
        <textarea id="input" placeholder="Scrivi un messaggio e premi Invio… (Shift+Invio va a capo)" spellcheck="true"></textarea>
        <button type="submit" id="send" class="send">Invia</button>
      </div>
    </form>
  </div>

  <script>
  // ------- UI Helpers -------
  const els = {
    stack: document.getElementById('stack'),
    input: document.getElementById('input'),
    send: document.getElementById('send'),
    messages: document.getElementById('messages'),
    statusDot: document.getElementById('statusDot'),
    statusText: document.getElementById('statusText')
  };

  function addBubble(role, text = '', thinking=false){
    const wrap = document.createElement('div');
    wrap.className = `bubble ${role}`;
    wrap.innerHTML = `<div class="txt">${sanitize(text)}</div>` + (thinking? `<div class="meta thinking">sta scrivendo…</div>` : '');
    els.stack.appendChild(wrap);
    requestAnimationFrame(() => els.messages.scrollTo({top: els.messages.scrollHeight, behavior: 'smooth'}));
    return wrap;
  }

  function sanitize(s){
    return (s||'').toString().replace(/[&<>]/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;'}[c]));
  }

  // ------- Intro message (contestualizza) -------
  function intro(){
    return `Ciao! Sono l’assistente di Manuel. Posso simulare un colloquio, raccontarti il suo profilo professionale o aiutarti con domande tecniche. Dimmi pure come posso esserti utile.`;
  }

  // ------- Networking -------
  const API_URL = '/.netlify/functions/gptHandler'; // Netlify Function
  let threadId = localStorage.getItem('threadId') || '';

  async function sendMessage(ev){
    if(ev) ev.preventDefault();
    const text = els.input.value.trim();
    if(!text) return;

    els.send.disabled = true;
    const userB = addBubble('user', text);
    els.input.value = '';
    autosize();

    const botB = addBubble('assistant', '', true);

    try {
      const res = await fetch(API_URL, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ message: text, threadId, summary: '' })
      });

      const newThread = res.headers.get('x-thread-id');
      if(newThread){ threadId = newThread; localStorage.setItem('threadId', threadId); }

      const ctype = (res.headers.get('content-type') || '').toLowerCase();
      if(ctype.includes('text/event-stream')){
        await readSSE(res, chunk => {
          botB.querySelector('.meta')?.remove();
          botB.querySelector('.txt').innerHTML += sanitize(chunk);
          els.messages.scrollTop = els.messages.scrollHeight;
        });
      } else if(ctype.includes('application/json')){
        const data = await res.json();
        botB.querySelector('.meta')?.remove();
        botB.querySelector('.txt').innerHTML = sanitize(data.reply || data.error || 'Errore');
      } else {
        botB.querySelector('.meta')?.remove();
        botB.querySelector('.txt').textContent = 'Errore di connessione: risposta inattesa.';
      }
    } catch (err){
      botB.querySelector('.meta')?.remove();
      botB.querySelector('.txt').textContent = 'Non riesco a connettermi al server. Controlla la Function Netlify e le variabili (OPENAI_API_KEY).';
      setStatus(false);
    } finally {
      els.send.disabled = false;
    }
  }

  async function readSSE(res, onChunk){
    const reader = res.body.getReader();
    const decoder = new TextDecoder('utf-8');
    let buffer = '';
    while(true){
      const {value, done} = await reader.read();
      if(done) break;
      buffer += decoder.decode(value, {stream:true});
      let idx;
      while((idx = buffer.indexOf('\n\n')) !== -1){
        const evt = buffer.slice(0, idx); buffer = buffer.slice(idx+2);
        const line = evt.split('\n').find(l => l.startsWith('data:')) || '';
        const payload = line.replace(/^data:\s?/, '');
        if(payload === '[DONE]') return;
        if(payload) onChunk(payload);
      }
    }
  }

  function autosize(){
    const maxPx = 160; // coerente con CSS
    els.input.style.height = 'auto';
    els.input.style.height = Math.min(els.input.scrollHeight, maxPx) + 'px';
  }

  function setStatus(ok){
    els.statusDot.classList.toggle('warn', !ok);
    els.statusText.textContent = ok ? 'Pronto' : 'Offline';
  }

  // Ping leggero alla function (non blocca UI)
  async function ping(){
    try{ await fetch(API_URL, {method:'OPTIONS'}); setStatus(true); }
    catch{ setStatus(false); }
  }

  // ------- Bindings -------
  document.getElementById('composer').addEventListener('submit', sendMessage);
  els.input.addEventListener('input', autosize);
  els.input.addEventListener('keydown', ev => {
    if(ev.key === 'Enter' && !ev.shiftKey){ ev.preventDefault(); sendMessage(); }
  });

  // ------- Start -------
  addBubble('assistant', intro());
  autosize();
  ping();
  setInterval(ping, 15000);
  </script>
</body>
</html>

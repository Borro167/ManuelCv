<!doctype html>
<html lang="it" data-theme="dark">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0" />
  <meta name="color-scheme" content="dark light" />
  <title>Assistente di Manuel — Chat</title>
  <style>
    :root{
      --bg:#0a0e1a;--bg-grad-1:#0a0e1a;--bg-grad-2:#0f1729;
      --surface:#101829dd;--surface-2:#141f38dd;--card:#1a2540;
      --text:#f0f4ff;--muted:#9ca9cd;--primary:#5b8aff;--accent:#7c5cff;
      --ok:#2dd4a3;--warn:#ffb74d;--border:1px solid rgba(255,255,255,.1);
      --shadow:0 8px 32px rgba(0,0,0,.4);--pad:clamp(16px,3vw,24px);
      --radius:20px;--radius-sm:14px;
    }
    :root[data-theme="light"]{
      --bg:#f5f8ff;--bg-grad-1:#ffffff;--bg-grad-2:#eef2ff;
      --surface:#ffffffee;--surface-2:#ffffffdd;--card:#ffffff;
      --text:#1a2138;--muted:#5a6580;--border:1px solid rgba(0,0,0,.1);
      --shadow:0 4px 24px rgba(0,0,0,.08);
    }
    *{box-sizing:border-box;margin:0;padding:0}
    html,body{height:100%;margin:0}
    body{
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
      color:var(--text);
      background:
        radial-gradient(ellipse 1400px 900px at 20% -5%, rgba(91,138,255,.12), transparent),
        radial-gradient(ellipse 1200px 700px at 90% 10%, rgba(124,92,255,.1), transparent),
        linear-gradient(135deg, var(--bg-grad-1) 0%, var(--bg-grad-2) 100%);
      overflow:hidden;
      -webkit-font-smoothing:antialiased;
      -moz-osx-font-smoothing:grayscale;
    }
    .wrap{height:100dvh;display:grid;grid-template-rows:auto 1fr auto;}

    /* HEADER */
    .header{
      position:sticky;top:0;z-index:20;
      display:flex;align-items:center;justify-content:space-between;gap:16px;
      padding:16px var(--pad);
      backdrop-filter:blur(20px) saturate(180%);
      background:linear-gradient(180deg, var(--surface) 0%, transparent 100%);
      border-bottom:var(--border);
    }
    .brand{display:flex;align-items:center;gap:14px}
    .logo{
      width:42px;height:42px;
      display:grid;place-items:center;
      border-radius:12px;
      background:linear-gradient(135deg,var(--primary) 0%,var(--accent) 100%);
      color:#fff;font-size:20px;font-weight:900;
      box-shadow:0 4px 16px rgba(91,138,255,.3);
    }
    .title{font-weight:700;font-size:1.1em;letter-spacing:-.02em}
    .status{display:flex;align-items:center;gap:10px;font-size:.9em;color:var(--muted)}
    .dot{
      width:10px;height:10px;border-radius:50%;
      background:var(--warn);
      box-shadow:0 0 0 3px rgba(255,183,77,.2);
      animation:pulse 2s ease-in-out infinite;
    }
    @keyframes pulse{0%,100%{opacity:1}50%{opacity:.6}}

    /* CHAT AREA */
    .chat{
      max-width:1000px;margin:0 auto;
      padding:24px var(--pad);
      overflow:auto;scroll-behavior:smooth;
    }
    .msgs{display:flex;flex-direction:column;gap:16px;padding-bottom:32px}

    /* MESSAGGI */
    .msg{
      max-width:min(720px, 88%);
      padding:16px 20px;
      border-radius:var(--radius);
      line-height:1.6;
      background:var(--card);
      backdrop-filter:blur(10px);
      box-shadow:var(--shadow);
      border:var(--border);
      animation:slideIn .2s ease-out;
      white-space:pre-wrap;
      word-wrap:break-word;
      font-size:15px;
    }
    .msg.me{
      align-self:flex-end;
      background:linear-gradient(135deg, #2d4a8c 0%, #1e3560 100%);
      border-color:rgba(91,138,255,.2);
    }
    .msg.bot{
      align-self:flex-start;
      background:linear-gradient(135deg, var(--card) 0%, #151f38 100%);
      border-color:rgba(255,255,255,.08);
    }
    .meta{
      display:flex;gap:8px;align-items:center;
      color:var(--muted);font-size:.85em;
      margin-top:8px;opacity:.8;
    }
    @keyframes slideIn{
      from{opacity:0;transform:translateY(10px)}
      to{opacity:1;transform:translateY(0)}
    }

    /* COMPOSER */
    .composer{
      position:sticky;bottom:0;z-index:15;
      padding:16px var(--pad) calc(16px + env(safe-area-inset-bottom));
      background:linear-gradient(0deg, var(--surface-2) 0%, transparent 100%);
      backdrop-filter:blur(20px) saturate(180%);
      border-top:var(--border);
    }
    .row{max-width:1000px;margin:0 auto;display:flex;gap:12px;align-items:flex-end}
    textarea{
      flex:1;min-height:52px;max-height:35dvh;
      resize:none;padding:14px 18px;
      border-radius:var(--radius-sm);
      border:var(--border);
      background:rgba(255,255,255,.04);
      color:var(--text);
      font-size:15px;font-family:inherit;line-height:1.5;
      outline:none;
      transition:all .2s ease;
    }
    textarea:focus{
      background:rgba(255,255,255,.06);
      border-color:rgba(91,138,255,.4);
      box-shadow:0 0 0 3px rgba(91,138,255,.1);
    }
    .btn{
      height:52px;
      display:inline-flex;align-items:center;gap:8px;
      padding:0 24px;
      border-radius:var(--radius-sm);
      border:none;cursor:pointer;
      font-weight:700;font-size:15px;
      color:#fff;
      background:linear-gradient(135deg, var(--primary) 0%, var(--accent) 100%);
      box-shadow:0 4px 16px rgba(91,138,255,.3);
      transition:all .2s ease;
    }
    .btn:hover:not([disabled]){
      transform:translateY(-2px);
      box-shadow:0 6px 20px rgba(91,138,255,.4);
    }
    .btn:active:not([disabled]){transform:translateY(0)}
    .btn[disabled]{opacity:.6;cursor:not-allowed}

    /* RESPONSIVE */
    @media (max-width:768px){
      .msg{max-width:90%;font-size:14px;padding:14px 16px}
      .logo{width:36px;height:36px;font-size:18px}
      .title{font-size:1em}
      textarea{font-size:14px;padding:12px 16px}
      .btn{padding:0 20px;font-size:14px}
    }
    @media (prefers-reduced-motion:reduce){
      *{animation:none !important;transition:none !important;scroll-behavior:auto}
    }
  </style>
</head>
<body>
  <div class="wrap">
    <header class="header">
      <div class="brand">
        <div class="logo">M</div>
        <div class="title">Assistente di Manuel</div>
      </div>
      <div class="status" title="Stato server">
        <span class="dot" id="netDot"></span>
        <span id="netText">controllo…</span>
      </div>
    </header>

    <main class="chat" aria-live="polite">
      <div class="msgs" id="messages"></div>
    </main>

    <footer class="composer">
      <div class="row">
        <textarea id="input" placeholder="Scrivi e premi Invio… (Shift+Invio va a capo)" autocomplete="off"></textarea>
        <button id="send" class="btn" type="button">Invia</button>
      </div>
    </footer>
  </div>

  <script>
"use strict";
const el = {
  messages: document.getElementById("messages"),
  input: document.getElementById("input"),
  send: document.getElementById("send"),
  netDot: document.getElementById("netDot"),
  netText: document.getElementById("netText")
};

let threadId = null;
const nowTime = () => new Date().toLocaleTimeString([], { hour:"2-digit", minute:"2-digit" });

// HTML escape totale
function escapeText(s){ return String(s).replace(/[&<>"]/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;'}[m])); }

// rimozione citazioni/link visibili
function cleanChat(text){
  let s = String(text || "");
  s = s.replace(/[【〔][^】〕]*[】〕]/g, "");
  s = s.replace(/(?:\s*`?\[(?:\^\w+|\d+(?::[^\]]+)?|[^\]]{1,120}\.(?:pdf|docx?|xlsx?|pptx?|txt|md|png|jpe?g|webp|svg))\]`?)+/gi, "");
  s = s.replace(/\[([^\]]+)\]\(([^)]+)\)/g, "$1");
  s = s.replace(/<https?:\/\/[^>\s]+>/gi, "");
  s = s.replace(/`{1,3}([\s\S]*?)`{1,3}/g, "$1");
  s = s.replace(/\s*[\(\[\{]\s*[\)\]\}]\s*/g, "");
  s = s.replace(/\s{2,}/g, " ").replace(/\s+([,.;:!?])/g, "$1");
  return s;
}

function getBehavior(){
  return [
    "Parla chiaro e sintetico.",
    "Punto chiave subito, poi dettagli.",
    "Quando fornisci liste usa SEMPRE questo formato:",
    "• Punto 1",
    "• Punto 2",
    "• Punto 3",
    "Per passi numerati usa:",
    "1. Primo elemento",
    "2. Secondo elemento",
    "3. Terzo elemento",
    "Niente link o citazioni in chiaro.",
    "Coerente col ruolo di assistente di Manuel.",
    "Non inventare dati."
  ].join("\n");
}

function introText(){
  return "Hi, I'm Manuel. How can I help you?";
}

// UI
function addBubble(role, text){
  const wrap = document.createElement("div");
  wrap.className = `msg ${role==="user"?"me":"bot"}`;
  wrap.textContent = text;
  const meta = document.createElement("div");
  meta.className = "meta";
  meta.textContent = nowTime();
  wrap.appendChild(meta);
  el.messages.appendChild(wrap);
  el.messages.parentElement.scrollTop = el.messages.parentElement.scrollHeight;
  return wrap;
}
function addStreamingBubble(){
  const wrap = document.createElement("div");
  wrap.className = "msg bot";
  const txt = document.createElement("div");
  txt.textContent = "";
  const meta = document.createElement("div");
  meta.className = "meta";
  meta.textContent = "…";
  wrap.appendChild(txt);
  wrap.appendChild(meta);
  el.messages.appendChild(wrap);
  el.messages.parentElement.scrollTop = el.messages.parentElement.scrollHeight;
  return { wrap, txt, meta };
}

// parsers: accetta sia JSON line-by-line sia SSE "data: {...}"
function extractTextDelta(evt){
  // supporta diversi formati evento (Assistants/Responses)
  const e = evt?.event || evt?.type;
  const data = evt?.data || evt;

  // 1) Assistants v2: thread.message.delta -> data.delta.content[].text.value
  if (e === "thread.message.delta" || e === "message.delta") {
    let out = "";
    const parts = data?.delta?.content || [];
    for (const p of parts) {
      // output_text / input_text / text
      if (p?.text?.value) out += p.text.value;
      else if (typeof p?.text === "string") out += p.text;
    }
    return out;
  }

  // 2) Responses API: response.output_text.delta -> data.delta
  if (e === "response.output_text.delta") {
    return data?.delta ?? "";
  }

  return "";
}

async function ping(){
  try{
    const res = await fetch("/.netlify/functions/gptHandler", { method:"OPTIONS" });
    el.netDot.style.background = res.ok ? "var(--ok)" : "var(--warn)";
    el.netText.textContent = res.ok ? "online" : "non raggiungibile";
  }catch{
    el.netDot.style.background = "var(--warn)";
    el.netText.textContent = "non raggiungibile";
  }
}

async function sendMessage(){
  const text = (el.input.value || "").trim();
  if(!text) return;

  addBubble("user", text);
  el.input.value = "";
  el.send.disabled = true;

  const streamUI = addStreamingBubble();

  const payload = {
    message: text,
    threadId,
    behavior: getBehavior(),
    summary: ""
  };

  try{
    const res = await fetch("/.netlify/functions/gptHandler", {
      method: "POST",
      headers: { "Content-Type": "application/json", "Accept": "text/event-stream" },
      body: JSON.stringify(payload)
    });

    el.netDot.style.background = res.ok ? "var(--ok)" : "var(--warn)";
    el.netText.textContent = res.ok ? "online" : `errore ${res.status}`;

    const hdrTid = res.headers.get("x-thread-id");
    if (!threadId && hdrTid) threadId = hdrTid;

    const ctype = (res.headers.get("Content-Type") || "").toLowerCase();

    if (res.ok && res.body && (ctype.includes("event-stream") || ctype.includes("text"))) {
      // STREAM DI EVENTI -> mostriamo solo le parti di testo
      const reader = res.body.getReader();
      const decoder = new TextDecoder();
      let buf = "";
      let full = "";

      while (true) {
        const { value, done } = await reader.read();
        if (done) break;
        buf += decoder.decode(value, { stream: true });

        // split per linee; teniamo l'ultima (potrebbe essere incompleta)
        const lines = buf.split(/\r?\n/);
        buf = lines.pop() || "";

        for (let line of lines) {
          line = line.trim();
          if (!line) continue;
          if (line.startsWith("data:")) line = line.slice(5).trim();
          if (line === "[DONE]") continue;

          try {
            const evt = JSON.parse(line);
            const delta = extractTextDelta(evt);
            if (delta) {
              full += delta;
              streamUI.txt.textContent = cleanChat(full);
              el.messages.parentElement.scrollTop = el.messages.parentElement.scrollHeight;
            }
          } catch { /* ignora frammenti non JSON */ }
        }
      }
      streamUI.meta.textContent = nowTime();
    } else {
      // FALLBACK non-stream (JSON)
      const data = await res.json().catch(()=>({}));
      const reply = data?.reply || "Nessuna risposta ricevuta.";
      streamUI.txt.textContent = cleanChat(reply);
      streamUI.meta.textContent = nowTime();
      if (!threadId && data?.threadId) threadId = data.threadId;
    }
  } catch (err) {
    streamUI.txt.textContent = "Errore di connessione. Riprova tra poco.";
    streamUI.meta.textContent = nowTime();
    el.netDot.style.background = "var(--warn)";
    el.netText.textContent = "non raggiungibile";
    console.error(err);
  } finally {
    el.send.disabled = false;
    el.input.focus();
  }
}

// UX
function autosize(){ el.input.style.height="auto"; const maxPx=Math.round(window.innerHeight*0.33); el.input.style.height=Math.min(el.input.scrollHeight,maxPx)+"px"; }
el.send.addEventListener("click", sendMessage);
el.input.addEventListener("keydown", (ev)=>{ if(ev.key==="Enter" && !ev.shiftKey){ ev.preventDefault(); sendMessage(); } });
el.input.addEventListener("input", autosize);

// avvio
addBubble("assistant", introText());
autosize();
ping();
setInterval(ping, 15000);
  </script>
</body>
</html>

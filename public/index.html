<!doctype html>
<html lang="it" data-theme="dark">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0" />
  <meta name="color-scheme" content="dark light" />
  <title>Assistente di Manuel — Chat</title>
  <style>
    :root{
      --bg:#0b0f1a;--bg-grad-1:#0b0f1a;--bg-grad-2:#121a2f;
      --surface:#0f1629cc;--surface-2:#121a2fcc;--card:#131c37aa;
      --text:#e9eefc;--muted:#aab3cd;--primary:#86a6ff;--accent:#b38bff;
      --ok:#35d39e;--warn:#ffb64d;--border:1px solid rgba(255,255,255,.08);
      --shadow:0 10px 40px rgba(0,0,0,.55);--pad:clamp(12px,2vw,20px)
    }
    :root[data-theme="light"]{
      --bg:#f7f8ff;--bg-grad-1:#f7f8ff;--bg-grad-2:#e9ecff;
      --surface:#ffffffcc;--surface-2:#ffffffee;--card:#ffffffcc;
      --text:#0b0f1a;--muted:#4a5470;--border:1px solid rgba(0,0,0,.08);
      --shadow:0 12px 36px rgba(0,0,0,.10)
    }
    *{box-sizing:border-box} html,body{height:100%;margin:0}
    body{
      font-family: ui-sans-serif, system-ui, Segoe UI, Roboto, Helvetica, Arial;
      color:var(--text);
      background:
        radial-gradient(1200px 800px at 10% -10%, #23326b44, transparent),
        radial-gradient(1000px 600px at 100% 0%, #5b3cc744, transparent),
        linear-gradient(160deg, var(--bg-grad-1), var(--bg-grad-2));
      overflow:hidden;
    }
    .wrap{height:100dvh;display:grid;grid-template-rows:auto 1fr auto;}
    .header{position:sticky;top:0;z-index:20;display:flex;align-items:center;justify-content:space-between;gap:10px;padding:10px var(--pad);backdrop-filter: blur(10px);background:linear-gradient(180deg, var(--surface), transparent);border-bottom:var(--border)}
    .brand{display:flex;align-items:center;gap:12px}
    .logo{width:32px;height:32px;display:grid;place-items:center;border-radius:10px;background:linear-gradient(135deg,var(--primary),var(--accent));color:#0b0f1a;font-weight:900;box-shadow:var(--shadow)}
    .title{font-weight:700;letter-spacing:.2px}
    .status{display:flex;align-items:center;gap:8px;font-size:.95em;color:var(--muted)}
    .dot{width:10px;height:10px;border-radius:999px;background:var(--warn);box-shadow:0 0 0 2px #0002}
    .chat{max-width:980px;margin:0 auto;padding:16px var(--pad);overflow:auto;scroll-behavior:smooth}
    .msgs{display:flex;flex-direction:column;gap:12px;padding-bottom:24px}
    .msg{max-width:min(780px, 90%);padding:12px 14px;border-radius:18px;line-height:1.45;background:var(--card);backdrop-filter: blur(6px);box-shadow:var(--shadow);border:var(--border);animation:pop .15s ease;white-space:pre-wrap}
    .msg.me{align-self:flex-end;background:linear-gradient(135deg,#20305f,#273a75)}
    .msg.bot{align-self:flex-start;background:linear-gradient(135deg,#121a32,#101527)}
    .meta{display:flex;gap:8px;align-items:center;color:var(--muted);font-size:.82em;margin-top:6px}
    .typing{width:54px;display:flex;gap:6px}
    .typing i{width:8px;height:8px;border-radius:50%;background:#c9d2f5;opacity:.6;animation:bump 1s infinite}
    .typing i:nth-child(2){animation-delay:.15s}
    .typing i:nth-child(3){animation-delay:.3s}
    @keyframes bump{0%{transform:translateY(0)}50%{transform:translateY(-4px)}100%{transform:translateY(0)}}
    @keyframes pop{from{transform:translateY(4px);opacity:.0}to{transform:translateY(0);opacity:1}}
    .composer{position:sticky;bottom:0;z-index:15;padding:12px var(--pad) calc(12px + env(safe-area-inset-bottom));background:linear-gradient(0deg, var(--surface-2), transparent);backdrop-filter: blur(10px);border-top:var(--border)}
    .row{max-width:980px;margin:0 auto;display:flex;gap:10px;align-items:flex-end}
    textarea{flex:1;min-height:48px;max-height:33dvh;resize:none;padding:12px 14px;border-radius:16px;border:var(--border);background:rgba(255,255,255,.03);color:var(--text);outline:none}
    .btn{height:48px;display:inline-flex;align-items:center;gap:10px;padding:0 16px;border-radius:14px;border:none;cursor:pointer;font-weight:700;color:#0b0f1a;background:linear-gradient(135deg,var(--primary),var(--accent));box-shadow:var(--shadow)}
    .btn[disabled]{opacity:.7;cursor:wait}
    @media (max-width:720px){.msg{max-width:92%}}
    @media (prefers-reduced-motion:reduce){*{scroll-behavior:auto}}
  </style>
</head>
<body>
  <div class="wrap">
    <header class="header">
      <div class="brand">
        <div class="logo">M</div>
        <div class="title">Assistente di Manuel</div>
      </div>
      <div class="status" title="Stato server">
        <span class="dot" id="netDot"></span>
        <span id="netText">controllo…</span>
      </div>
    </header>

    <main class="chat" aria-live="polite">
      <div class="msgs" id="messages"></div>
    </main>

    <footer class="composer">
      <div class="row">
        <textarea id="input" placeholder="Scrivi e premi Invio… (Shift+Invio va a capo)" autocomplete="off"></textarea>
        <button id="send" class="btn" type="button">Invia</button>
      </div>
    </footer>
  </div>

  <script>
"use strict";

// pulizia storage per test
try { localStorage.removeItem("history"); localStorage.removeItem("threadId"); } catch {}

const el = {
  messages: document.getElementById("messages"),
  input: document.getElementById("input"),
  send: document.getElementById("send"),
  netDot: document.getElementById("netDot"),
  netText: document.getElementById("netText"),
};

let threadId = null;

const nowTime = () => new Date().toLocaleTimeString([], { hour:"2-digit", minute:"2-digit" });

// ESCAPE totale (niente HTML in chat)
function escapeText(s){ return String(s).replace(/[&<>"]/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;'}[m])); }

// sanifica citazioni/footnote/link man mano che arrivano
function sanitizeProgressive(text){
  let s = String(text || "");
  s = s.replace(/[【〔][^】〕]*[】〕]/g, ""); // footnotes stile "[1†…]"
  s = s.replace(/(?:\s*`?\[(?:\^\w+|\d+(?::[^\]]+)?|[^\]]{1,120}\.(?:pdf|docx?|xlsx?|pptx?|txt|md|png|jpe?g|webp|svg))\]`?)+/gi, "");
  s = s.replace(/\[([^\]]+)\]\(([^)]+)\)/g, "$1"); // link md -> testo
  s = s.replace(/<https?:\/\/[^>\s]+>/gi, "");
  s = s.replace(/`{1,3}([\s\S]*?)`{1,3}/g, "$1"); // backtick
  s = s.replace(/\s*[\(\[\{]\s*[\)\]\}]\s*/g, "");
  s = s.replace(/\s{2,}/g, " ").replace(/\s+([,.;:!?])/g, "$1");
  return s;
}

function getBehavior(){
  return [
    "Parla chiaro e sintetico.",
    "Punto chiave subito, poi dettagli.",
    "Nessun link o citazione visibile in chat.",
    "Coerente col ruolo di assistente di Manuel.",
    "Non inventare dati."
  ].join("\n");
}

function introText(){
  return "Ciao! Sono l’assistente di Manuel. Rispondo in modo chiaro e breve, senza link o citazioni visibili. Come posso aiutarti?";
}

// UI helpers
function addBubble(role, text){
  const wrap = document.createElement("div");
  wrap.className = `msg ${role==="user"?"me":"bot"}`;
  wrap.textContent = text;
  const meta = document.createElement("div");
  meta.className = "meta";
  meta.textContent = nowTime();
  wrap.appendChild(meta);
  el.messages.appendChild(wrap);
  el.messages.parentElement.scrollTop = el.messages.parentElement.scrollHeight;
  return wrap;
}

function addStreamingBubble(){
  const wrap = document.createElement("div");
  wrap.className = "msg bot";
  const txt = document.createElement("div");
  txt.textContent = "";
  const meta = document.createElement("div");
  meta.className = "meta";
  meta.textContent = "…";
  wrap.appendChild(txt);
  wrap.appendChild(meta);
  el.messages.appendChild(wrap);
  el.messages.parentElement.scrollTop = el.messages.parentElement.scrollHeight;
  return { wrap, txt, meta };
}

async function ping(){
  try{
    const res = await fetch("/.netlify/functions/gptHandler", { method:"OPTIONS" });
    el.netDot.style.background = res.ok ? "var(--ok)" : "var(--warn)";
    el.netText.textContent = res.ok ? "online" : "non raggiungibile";
  }catch{
    el.netDot.style.background = "var(--warn)";
    el.netText.textContent = "non raggiungibile";
  }
}

async function sendMessage(){
  const text = (el.input.value || "").trim();
  if(!text) return;

  // utente
  addBubble("user", text);
  el.input.value = "";
  el.send.disabled = true;

  // bolla streaming
  const streamUI = addStreamingBubble();

  // prepara richiesta
  const payload = {
    message: text,
    threadId,
    behavior: getBehavior(),
    summary: ""
  };

  try{
    // fetch con risposta STREAM (text/plain) + fallback JSON
    const res = await fetch("/.netlify/functions/gptHandler", {
      method: "POST",
      headers: { "Content-Type": "application/json", "Accept": "text/plain" },
      body: JSON.stringify(payload)
    });

    // stato rete
    el.netDot.style.background = res.ok ? "var(--ok)" : "var(--warn)";
    el.netText.textContent = res.ok ? "online" : `errore ${res.status}`;

    // salva eventuale nuovo thread id dall'header
    const hdrTid = res.headers.get("x-thread-id");
    if (!threadId && hdrTid) threadId = hdrTid;

    const ctype = (res.headers.get("Content-Type") || "").toLowerCase();

    if (res.ok && ctype.startsWith("text/")) {
      // ---- STREAM LETTERA PER LETTERA ----
      const reader = res.body.getReader();
      const decoder = new TextDecoder();
      let raw = "";

      while (true) {
        const { value, done } = await reader.read();
        if (done) break;
        raw += decoder.decode(value, { stream: true });

        // sanifica progressivamente e mostra tutto il testo (tipo "macchina da scrivere")
        const clean = sanitizeProgressive(raw);
        streamUI.txt.textContent = clean;
        el.messages.parentElement.scrollTop = el.messages.parentElement.scrollHeight;
      }
      streamUI.meta.textContent = nowTime();
    } else {
      // ---- FALLBACK JSON (nessuno stream) ----
      const data = await res.json().catch(()=>({}));
      const reply = data?.reply || "Nessuna risposta ricevuta.";
      streamUI.txt.textContent = sanitizeProgressive(reply);
      streamUI.meta.textContent = nowTime();
      if (!threadId && data?.threadId) threadId = data.threadId;
    }
  } catch (err) {
    streamUI.txt.textContent = "Errore di connessione. Riprova tra poco.";
    streamUI.meta.textContent = nowTime();
    el.netDot.style.background = "var(--warn)";
    el.netText.textContent = "non raggiungibile";
    console.error(err);
  } finally {
    el.send.disabled = false;
    el.input.focus();
  }
}

// UX minime
function autosize(){ el.input.style.height="auto"; const maxPx=Math.round(window.innerHeight*0.33); el.input.style.height=Math.min(el.input.scrollHeight,maxPx)+"px"; }
el.send.addEventListener("click", sendMessage);
el.input.addEventListener("keydown", (ev)=>{ if(ev.key==="Enter" && !ev.shiftKey){ ev.preventDefault(); sendMessage(); } });
el.input.addEventListener("input", autosize);

// intro + ping
addBubble("assistant", introText());
autosize();
ping();
setInterval(ping, 15000);
  </script>
</body>
</html>

<!doctype html>
<html lang="it" data-theme="dark">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0">
  <title>Manuel Assistant · Chat</title>
  <meta name="description" content="Chat UI minimale con Netlify Functions e OpenAI Assistants.">
  <style>
    :root{
      --bg:#0b0f1a; --surface:#11182b; --surface-2:#1a2340;
      --text:#e8ecf8; --muted:#a8b0c8;
      --primary:#7ea2ff; --accent:#9c86ff;
      --border:rgba(255,255,255,.08); --shadow:0 14px 38px rgba(0,0,0,.45);
      --bubble-mine:#24305a; --bubble-theirs:#171f39;
    }
    [data-theme="light"]{
      --bg:#f6f8ff; --surface:#ffffff; --surface-2:#f0f3ff;
      --text:#0b0f1a; --muted:#445;
      --border:rgba(0,0,0,.08);
      --bubble-mine:#e9edff; --bubble-theirs:#f5f7ff;
    }
    *{ box-sizing:border-box }
    html, body{ height:100%; margin:0; background:var(--bg); color:var(--text); font-family: ui-sans-serif, system-ui, Segoe UI, Roboto, Helvetica, Arial }
    .topbar{
      position:sticky; top:0; z-index:10; backdrop-filter: blur(8px);
      display:flex; align-items:center; justify-content:space-between; gap:10px;
      padding:14px 16px; border-bottom:1px solid var(--border); background: color-mix(in oklab, var(--bg) 88%, transparent);
    }
    .title{ font-weight:800; letter-spacing:.2px }
    .top-actions{ display:flex; gap:8px; align-items:center }
    .btn{
      display:inline-flex; align-items:center; gap:8px; padding:10px 14px; border-radius:12px;
      background:linear-gradient(135deg, var(--primary), var(--accent)); border:none; color:white; font-weight:700; cursor:pointer;
      box-shadow: var(--shadow);
    }
    .btn.secondary{ background:transparent; color:var(--text); border:1px solid var(--border); box-shadow:none }
    .container{ max-width:980px; margin:0 auto; padding: 12px 16px 20px }
    .chat{ background:var(--surface); border:1px solid var(--border); border-radius:16px; overflow:hidden; box-shadow: var(--shadow) }
    .messages{ height:60dvh; overflow:auto; padding:16px; display:flex; flex-direction:column; gap:10px; scroll-behavior:smooth; }
    .bubble{ padding:12px 14px; border-radius:14px; max-width:80%; line-height:1.35; box-shadow: 0 8px 24px rgba(0,0,0,.25) }
    .me{ align-self:flex-end; background:var(--bubble-mine) }
    .bot{ align-self:flex-start; background:var(--bubble-theirs) }
    .composer{ background:var(--surface-2); display:flex; gap:10px; align-items:end; padding:12px; border-top:1px solid var(--border) }
    textarea{ flex:1; resize:none; min-height:44px; max-height:180px; border-radius:12px; padding:10px 12px; background:transparent; outline:none; color:var(--text); border:1px solid var(--border) }
    .mini{ display:flex; gap:8px; align-items:center; justify-content:space-between; padding:8px 0 0 }
    .mini .left, .mini .right{ display:flex; gap:8px; align-items:center }
    .chip{ font-size:.9em; opacity:.8 }
    @media (max-width:700px){
      .messages{ height:62dvh }
      .bubble{ max-width:86% }
    }
    @media print{
      .topbar, .composer, .mini{ display:none !important }
      .container{ width:100%; margin:0; padding:0 }
      .chat{ border:none; box-shadow:none }
      .messages{ height:auto }
      .bubble{ page-break-inside:avoid }
    }
  </style>
</head>
<body>
  <div class="topbar">
    <div class="title">Manuel Assistant</div>
    <div class="top-actions">
      <button id="newChat" class="btn secondary">Nuova chat</button>
      <button id="export" class="btn secondary">Esporta PDF</button>
      <button id="theme" class="btn secondary">Tema</button>
    </div>
  </div>

  <div class="container">
    <div class="chat">
      <div id="messages" class="messages"></div>
      <div class="composer">
        <textarea id="input" rows="1" placeholder="Scrivi un messaggio e premi Invio..."></textarea>
        <button id="send" class="btn">Invia</button>
      </div>
      <div class="mini">
        <div class="left">
          <span id="netStatus" class="chip">Server: sconosciuto</span>
        </div>
        <div class="right">
          <span class="chip">Thread: <span id="threadChip">—</span></span>
        </div>
      </div>
    </div>
  </div>

  <script>
    const el = {
      messages: document.getElementById('messages'),
      input: document.getElementById('input'),
      send: document.getElementById('send'),
      newChat: document.getElementById('newChat'),
      exportPdf: document.getElementById('export'),
      theme: document.getElementById('theme'),
      netStatus: document.getElementById('netStatus'),
      threadChip: document.getElementById('threadChip'),
    };

    // State
    let threadId = localStorage.getItem('threadId') || null;

    // Defaults
    const DEFAULT_START = "Sono l’assistente di Manuel. Ho accesso ai suoi ricordi: desideri sapere qualcosa su di lui?";

    // UI helpers
    function addBubble(text, who="bot"){
      const b = document.createElement('div');
      b.className = 'bubble ' + (who === 'me' ? 'me' : 'bot');
      b.innerHTML = text.replace(/\n/g, '<br>');
      el.messages.appendChild(b);
      el.messages.scrollTop = el.messages.scrollHeight;
      return b;
    }
    function addThinking(){
      const b = document.createElement('div');
      b.className = 'bubble bot';
      b.textContent = '…';
      el.messages.appendChild(b);
      el.messages.scrollTop = el.messages.scrollHeight;
      return b;
    }
    function autosize(){
      el.input.style.height = 'auto';
      el.input.style.height = Math.min(el.input.scrollHeight, 180) + 'px';
    }

    // Initial greeting (fisso, senza pannelli)
    if (!localStorage.getItem('greeted')){
      addBubble(DEFAULT_START, "bot");
      localStorage.setItem('greeted', '1');
    }

    // Buttons
    el.exportPdf.addEventListener('click', () => window.print());
    el.newChat.addEventListener('click', () => {
      el.messages.innerHTML = '';
      localStorage.removeItem('threadId');
      threadId = null;
      localStorage.removeItem('greeted');
      addBubble(DEFAULT_START, "bot");
      el.threadChip.textContent = '—';
    });
    el.theme.addEventListener('click', () => {
      const html = document.documentElement;
      const isDark = html.getAttribute('data-theme') !== 'light';
      html.setAttribute('data-theme', isDark ? 'light' : 'dark');
    });

    // Autosize + key bindings
    el.input.addEventListener('input', autosize);
    el.input.addEventListener('keydown', (e) => {
      if (e.key === 'Enter' && !e.shiftKey){
        e.preventDefault();
        sendMessage();
      }
    });
    el.send.addEventListener('click', sendMessage);

    // Ping server status
    (async () => {
      try{
        const r = await fetch('/.netlify/functions/gptHandler', { method: 'OPTIONS' });
        el.netStatus.textContent = r.ok ? 'Server: online' : 'Server: offline';
      }catch(e){
        el.netStatus.textContent = 'Server: offline';
      }
    })();

    // Main send
    async function sendMessage(){
      const text = el.input.value.trim();
      if (!text) return;
      el.input.value = "";
      autosize();
      addBubble(text, "me");
      const thinking = addThinking();

      try {
        const res = await fetch('/.netlify/functions/gptHandler', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ message: text, threadId })
        });
        const data = await res.json();
        thinking.remove();
        if (data?.reply) addBubble(data.reply, "bot");
        else addBubble("Risposta vuota dal server.", "bot");

        if (data?.threadId && !threadId) {
          threadId = data.threadId;
          localStorage.setItem('threadId', threadId);
          el.threadChip.textContent = threadId.slice(-6);
        }
      } catch (e) {
        thinking.remove();
        addBubble("Errore di connessione al server. Controlla che le variabili Netlify siano impostate e riprova.", "bot");
      }
    }
  </script>
</body>
</html>
